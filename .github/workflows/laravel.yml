name: Laravel

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]

concurrency:
  group: laravel-ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  laravel-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      APP_ENV: testing
      CACHE_DRIVER: array
      QUEUE_CONNECTION: sync
      SESSION_DRIVER: array
      BROADCAST_DRIVER: log

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: shivammathur/setup-php@15c43e89cdef867065b0213be354c2841860869e
        with:
          php-version: '8.4'
          extensions: mbstring, sqlite3, pcntl, intl
          coverage: none
          tools: composer:v2
          ini-values: memory_limit=512M
          cache: composer

      # Optional: cache vendor to skip full reinstalls when lockfile hasn't changed
      - name: Cache vendor
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-8.4-vendor-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-8.4-vendor-

      - name: Copy .env
        run: cp .env.example .env

      - name: Install dependencies
        run: composer install --no-ansi --no-interaction --no-progress --prefer-dist --optimize-autoloader

      - name: Generate key
        run: php artisan key:generate

      - name: Prepare SQLite databases for parallel testing
        run: |
          mkdir -p database
          # Base test database; Laravel will create per-process copies (e.g., test-1.sqlite)
          : > database/test.sqlite

      - name: Directory permissions
        run: chmod -R 777 storage bootstrap/cache

      - name: Run tests (parallel)
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/test.sqlite
        run: php artisan test --parallel --processes=auto
